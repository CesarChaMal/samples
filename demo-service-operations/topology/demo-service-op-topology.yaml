tosca_definitions_version: alien_dsl_1_4_0

metadata:
  template_name: demo-service-op-topology
  template_version: 1.4.0-SNAPSHOT
  template_author: alien4cloud

description: "A topology to test the relation's operations when using a service"

imports:
  - tosca-normative-types:1.0.0-ALIEN14
  - demo-service-operations:1.4.0-SNAPSHOT

topology_template:
  node_templates:
    ServiceSource:
      type: org.alien4cloud.nodes.demo.ServiceType
      requirements:
        - need_service:
            node: ConcreteType
            capability: org.alien4cloud.capabilities.demo.ServiceDemo
            relationship: org.alien4cloud.relationships.demo.ConnectsTo
    ServiceTarget:
      type: org.alien4cloud.nodes.demo.ServiceType
    ConcreteType:
      type: org.alien4cloud.nodes.demo.ConcreteType
      requirements:
        - host:
            node: ConcreteTypeCompute
            capability: tosca.capabilities.Container
            relationship: tosca.relationships.HostedOn
        - need_service:
            node: ServiceTarget
            capability: org.alien4cloud.capabilities.demo.ServiceDemo
            relationship: org.alien4cloud.relationships.demo.ConnectsTo
    ConcreteTypeCompute:
      type: tosca.nodes.Compute
      capabilities:
        scalable:
          properties:
            min_instances: 1
            max_instances: 1
            default_instances: 1
        endpoint:
          properties:
            secure: true
            protocol: tcp
            network_name: PRIVATE
            initiator: source
  workflows:
    install:
      steps:
        Compute_install:
          node: ConcreteTypeCompute
          activity:
            delegate: install
          on-success:
            - ConcreteType_initial
        ConcreteType_initial:
          node: ConcreteType
          activity:
            set_state: initial
          on-success:
            - ConcreteType_creating
        ConcreteType_creating:
          node: ConcreteType
          activity:
            set_state: creating
          on-success:
            - create_ConcreteType
        create_ConcreteType:
          node: ConcreteType
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.create
          on-success:
            - ConcreteType_created
        ConcreteType_created:
          node: ConcreteType
          activity:
            set_state: created
          on-success:
            - ConcreteType_configuring
        ConcreteType_configuring:
          node: ConcreteType
          activity:
            set_state: configuring
          on-success:
            - configure_ConcreteType
        configure_ConcreteType:
          node: ConcreteType
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.configure
          on-success:
            - ConcreteType_configured
        ConcreteType_configured:
          node: ConcreteType
          activity:
            set_state: configured
          on-success:
            - ConcreteType_starting
        ConcreteType_starting:
          node: ConcreteType
          activity:
            set_state: starting
          on-success:
            - start_ConcreteType
        start_ConcreteType:
          node: ConcreteType
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - ConcreteType_started
        ConcreteType_started:
          node: ConcreteType
          activity:
            set_state: started
        ServiceType_install:
          node: ServiceTarget
          activity:
            delegate: install
          on-success:
            - ConcreteType_initial
        ServiceType_2_install:
          node: ServiceSource
          activity:
            delegate: install
    uninstall:
      steps:
        Compute_uninstall:
          node: ConcreteTypeCompute
          activity:
            delegate: uninstall
        ConcreteType_stopping:
          node: ConcreteType
          activity:
            set_state: stopping
          on-success:
            - stop_ConcreteType
        stop_ConcreteType:
          node: ConcreteType
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - ConcreteType_stopped
        ConcreteType_stopped:
          node: ConcreteType
          activity:
            set_state: stopped
          on-success:
            - ConcreteType_deleting
        ConcreteType_deleting:
          node: ConcreteType
          activity:
            set_state: deleting
          on-success:
            - delete_ConcreteType
        delete_ConcreteType:
          node: ConcreteType
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.delete
          on-success:
            - ConcreteType_deleted
        ConcreteType_deleted:
          node: ConcreteType
          activity:
            set_state: deleted
          on-success:
            - ServiceType_uninstall
            - Compute_uninstall
        ServiceType_uninstall:
          node: ServiceTarget
          activity:
            delegate: uninstall
        ServiceType_2_uninstall:
          node: ServiceSource
          activity:
            delegate: uninstall
    start:
      steps:
        Compute_start:
          node: ConcreteTypeCompute
          activity:
            delegate: start
          on-success:
            - ConcreteType_starting
        ConcreteType_starting:
          node: ConcreteType
          activity:
            set_state: starting
          on-success:
            - start_ConcreteType
        start_ConcreteType:
          node: ConcreteType
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - ConcreteType_started
        ConcreteType_started:
          node: ConcreteType
          activity:
            set_state: started
        ServiceType_start:
          node: ServiceTarget
          activity:
            delegate: start
          on-success:
            - ConcreteType_starting
        ServiceType_2_start:
          node: ServiceSource
          activity:
            delegate: start
    stop:
      steps:
        Compute_stop:
          node: ConcreteTypeCompute
          activity:
            delegate: stop
        ConcreteType_stopping:
          node: ConcreteType
          activity:
            set_state: stopping
          on-success:
            - stop_ConcreteType
        stop_ConcreteType:
          node: ConcreteType
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - ConcreteType_stopped
        ConcreteType_stopped:
          node: ConcreteType
          activity:
            set_state: stopped
          on-success:
            - ServiceType_stop
            - Compute_stop
        ServiceType_stop:
          node: ServiceTarget
          activity:
            delegate: stop
        ServiceType_2_stop:
          node: ServiceSource
          activity:
            delegate: stop
